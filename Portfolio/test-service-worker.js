// Script pour tester le service worker
const fs = require('fs');
const path = require('path');

// V√©rifier si le fichier service-worker.js existe
const serviceWorkerPath = path.join(__dirname, 'portfolio-client-2025', 'public', 'service-worker.js');
const serviceWorkerExists = fs.existsSync(serviceWorkerPath);

console.log(`Service Worker existe: ${serviceWorkerExists}`);

if (serviceWorkerExists) {
  // Lire le contenu du fichier service-worker.js
  const serviceWorkerContent = fs.readFileSync(serviceWorkerPath, 'utf8');
  
  // V√©rifier si le fichier contient les √©l√©ments essentiels
  const hasCacheName = serviceWorkerContent.includes('CACHE_NAME');
  const hasPrecacheAssets = serviceWorkerContent.includes('PRECACHE_ASSETS');
  const hasRuntimeCachePatterns = serviceWorkerContent.includes('RUNTIME_CACHE_PATTERNS');
  const hasInstallEventListener = serviceWorkerContent.includes("self.addEventListener('install'");
  const hasActivateEventListener = serviceWorkerContent.includes("self.addEventListener('activate'");
  const hasFetchEventListener = serviceWorkerContent.includes("self.addEventListener('fetch'");
  
  console.log(`\nV√©rification du contenu du Service Worker:`);
  console.log(`- Nom de cache d√©fini: ${hasCacheName}`);
  console.log(`- Ressources √† pr√©charger d√©finies: ${hasPrecacheAssets}`);
  console.log(`- Patterns de cache runtime d√©finis: ${hasRuntimeCachePatterns}`);
  console.log(`- √âcouteur d'√©v√©nement 'install': ${hasInstallEventListener}`);
  console.log(`- √âcouteur d'√©v√©nement 'activate': ${hasActivateEventListener}`);
  console.log(`- √âcouteur d'√©v√©nement 'fetch': ${hasFetchEventListener}`);
  
  // V√©rifier si tous les √©l√©ments essentiels sont pr√©sents
  const allEssentialElementsPresent = hasCacheName && hasPrecacheAssets && hasRuntimeCachePatterns && 
                                     hasInstallEventListener && hasActivateEventListener && hasFetchEventListener;
  
  console.log(`\nTous les √©l√©ments essentiels sont pr√©sents: ${allEssentialElementsPresent}`);
}

// V√©rifier si le fichier manifest.json existe
const manifestPath = path.join(__dirname, 'portfolio-client-2025', 'public', 'manifest.json');
const manifestExists = fs.existsSync(manifestPath);

console.log(`\nManifest existe: ${manifestExists}`);

if (manifestExists) {
  // Lire le contenu du fichier manifest.json
  const manifestContent = fs.readFileSync(manifestPath, 'utf8');
  
  try {
    // Parser le contenu JSON
    const manifest = JSON.parse(manifestContent);
    
    // V√©rifier si le manifest contient les √©l√©ments essentiels
    const hasName = !!manifest.name;
    const hasShortName = !!manifest.short_name;
    const hasStartUrl = !!manifest.start_url;
    const hasDisplay = !!manifest.display;
    const hasIcons = Array.isArray(manifest.icons) && manifest.icons.length > 0;
    
    console.log(`\nV√©rification du contenu du Manifest:`);
    console.log(`- Nom d√©fini: ${hasName}`);
    console.log(`- Nom court d√©fini: ${hasShortName}`);
    console.log(`- URL de d√©marrage d√©finie: ${hasStartUrl}`);
    console.log(`- Mode d'affichage d√©fini: ${hasDisplay}`);
    console.log(`- Ic√¥nes d√©finies: ${hasIcons}`);
    
    // V√©rifier si tous les √©l√©ments essentiels sont pr√©sents
    const allEssentialElementsPresent = hasName && hasShortName && hasStartUrl && hasDisplay && hasIcons;
    
    console.log(`\nTous les √©l√©ments essentiels sont pr√©sents: ${allEssentialElementsPresent}`);
  } catch (error) {
    console.error(`Erreur lors du parsing du manifest: ${error.message}`);
  }
}

// V√©rifier si le fichier serviceWorkerRegistration.ts existe
const serviceWorkerRegistrationPath = path.join(__dirname, 'portfolio-client-2025', 'src', 'serviceWorkerRegistration.ts');
const serviceWorkerRegistrationExists = fs.existsSync(serviceWorkerRegistrationPath);

console.log(`\nService Worker Registration existe: ${serviceWorkerRegistrationExists}`);

if (serviceWorkerRegistrationExists) {
  // Lire le contenu du fichier serviceWorkerRegistration.ts
  const serviceWorkerRegistrationContent = fs.readFileSync(serviceWorkerRegistrationPath, 'utf8');
  
  // V√©rifier si le fichier contient les √©l√©ments essentiels
  const hasRegisterFunction = serviceWorkerRegistrationContent.includes('registerServiceWorker');
  const hasUnregisterFunction = serviceWorkerRegistrationContent.includes('unregisterServiceWorker');
  const hasServiceWorkerCheck = serviceWorkerRegistrationContent.includes('serviceWorker');
  
  console.log(`\nV√©rification du contenu du Service Worker Registration:`);
  console.log(`- Fonction d'enregistrement d√©finie: ${hasRegisterFunction}`);
  console.log(`- Fonction de d√©senregistrement d√©finie: ${hasUnregisterFunction}`);
  console.log(`- V√©rification de support du Service Worker: ${hasServiceWorkerCheck}`);
  
  // V√©rifier si tous les √©l√©ments essentiels sont pr√©sents
  const allEssentialElementsPresent = hasRegisterFunction && hasUnregisterFunction && hasServiceWorkerCheck;
  
  console.log(`\nTous les √©l√©ments essentiels sont pr√©sents: ${allEssentialElementsPresent}`);
}

// V√©rifier si le fichier OfflineNotification.tsx existe
const offlineNotificationPath = path.join(__dirname, 'portfolio-client-2025', 'src', 'components', 'OfflineNotification.tsx');
const offlineNotificationExists = fs.existsSync(offlineNotificationPath);

console.log(`\nOffline Notification existe: ${offlineNotificationExists}`);

if (offlineNotificationExists) {
  // Lire le contenu du fichier OfflineNotification.tsx
  const offlineNotificationContent = fs.readFileSync(offlineNotificationPath, 'utf8');
  
  // V√©rifier si le fichier contient les √©l√©ments essentiels
  const hasOnlineCheck = offlineNotificationContent.includes('navigator.onLine');
  const hasEventListeners = offlineNotificationContent.includes("addEventListener('online'") && 
                           offlineNotificationContent.includes("addEventListener('offline'");
  
  console.log(`\nV√©rification du contenu de Offline Notification:`);
  console.log(`- V√©rification de l'√©tat de connexion: ${hasOnlineCheck}`);
  console.log(`- √âcouteurs d'√©v√©nements online/offline: ${hasEventListeners}`);
  
  // V√©rifier si tous les √©l√©ments essentiels sont pr√©sents
  const allEssentialElementsPresent = hasOnlineCheck && hasEventListeners;
  
  console.log(`\nTous les √©l√©ments essentiels sont pr√©sents: ${allEssentialElementsPresent}`);
}

console.log('\nR√©sum√© des tests:');
console.log('- Service Worker: ' + (serviceWorkerExists ? '‚úÖ' : '‚ùå'));
console.log('- Manifest: ' + (manifestExists ? '‚úÖ' : '‚ùå'));
console.log('- Service Worker Registration: ' + (serviceWorkerRegistrationExists ? '‚úÖ' : '‚ùå'));
console.log('- Offline Notification: ' + (offlineNotificationExists ? '‚úÖ' : '‚ùå'));

const allFilesExist = serviceWorkerExists && manifestExists && serviceWorkerRegistrationExists && offlineNotificationExists;
console.log('\nTous les fichiers n√©cessaires existent: ' + (allFilesExist ? '‚úÖ' : '‚ùå'));

if (allFilesExist) {
  console.log('\nüéâ Les optimisations de mise en cache ont √©t√© correctement impl√©ment√©es!');
  console.log('Pour tester compl√®tement ces optimisations, vous devrez:');
  console.log('1. D√©marrer l\'application avec "npm run dev"');
  console.log('2. Ouvrir l\'application dans un navigateur');
  console.log('3. V√©rifier dans les DevTools (onglet Application > Service Workers) si le service worker est enregistr√©');
  console.log('4. V√©rifier dans les DevTools (onglet Application > Cache Storage) si les ressources sont mises en cache');
  console.log('5. Simuler une connexion hors ligne (DevTools > Network > Offline) pour tester le fonctionnement en mode d√©connect√©');
}
